<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Repetitor.tj — Журнал нарушений</title>
<link rel="icon" type="image/png" href="https://repetitor.mobi/_next/image?url=%2Fassets%2Fsignin-repetitor.png&w=384&q=75">
<style>
  :root{
    --primary:#29A9E8; --danger:#E23D3B; --ok:#22C55E; --white:#FFFFFF;
    --text:#0B1520; --muted:#5A6B7A; --line:#E7EEF3;
    --shadow:0 12px 28px rgba(11,21,32,.08); --radius:16px;
  }
  *{ box-sizing:border-box }
  body{ margin:0; background:#F6FAFD; color:var(--text); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }
  .wrap{ max-width:560px; margin:0 auto; padding:20px; display:flex; flex-direction:column; gap:16px }
  header h1{ margin:6px 0 2px; font-size:22px; display:flex; gap:10px; align-items:center }
  header p{ margin:0; color:var(--muted); font-size:13px }

  .card{ background:var(--white); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:12px }
  label{ font-weight:600; font-size:14px; margin-bottom:6px; display:block }
  input[type="text"], select, textarea{ width:100%; border-radius:12px; border:1px solid var(--line); outline:none; background:#FBFDFF; padding:12px 14px }
  textarea{ min-height:84px; resize:vertical }
  input:focus,select:focus,textarea:focus{ border-color:var(--primary) }
  .row{ display:flex; flex-direction:column; gap:12px }

  .btn{
    background:var(--primary); color:#fff; border:0; padding:12px 16px;
    font-weight:700; cursor:pointer; transition:transform .08s ease,opacity .2s ease;
    display:flex; align-items:center; justify-content:center; gap:10px; border-radius:12px;
  }
  .btn.secondary{ background:#fff; color:var(--danger); border:1px solid #F3D1CF }
  .btn:active{ transform:translateY(1px) }
  .btn:disabled{ opacity:.6; cursor:not-allowed }

  .status{ display:flex; align-items:center; gap:10px; background:#F1FAFE; color:#0B6B94; border:1px dashed #CFEAFA; padding:10px 12px; border-radius:12px; font-size:14px }
  .muted{ color:var(--muted); font-size:12px }

  .students{ display:flex; flex-direction:column; gap:8px }
  .student{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px solid var(--line); background:#fff; border-radius:12px }
  .student label{ margin:0; font-weight:500 }
  .checks{ display:flex; gap:12px; flex-wrap:wrap }
  .check{ display:flex; align-items:center; gap:8px; border:1px solid var(--line); background:#fff; padding:8px 10px; border-radius:10px; font-size:14px }

  .chips{ display:flex; gap:8px; flex-wrap:wrap }
  .chip{ display:inline-flex; align-items:center; gap:8px; background:#F2F9FE; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted) }

  .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid rgba(0,0,0,.2); border-top-color:transparent; animation:spin 1s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  .snackbar{ position:fixed; left:50%; bottom:16px; transform:translateX(-50%) translateY(20px); background:var(--primary); color:#fff; padding:12px 16px; border-radius:999px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:.25s ease }
  .snackbar.show{ opacity:1; transform:translateX(-50%) translateY(0) }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>
      <img src="https://repetitor.mobi/_next/image?url=%2Fassets%2Fsignin-repetitor.png&w=384&q=75" alt="Repetitor.tj" style="height:50px">
      <span style="line-height:1.1">Журнал нарушений</span>
    </h1>
    <p></p>
  </header>

  <!-- Форма выбора -->
  <section class="card" aria-live="polite">
    <div class="row">
      <div>
        <label for="teacher">Преподаватель</label>
        <input id="teacher" type="text" placeholder="Например: Бакоев Фаррух">
        <div class="muted" id="teacherHint"></div>
      </div>

      <div>
        <label for="subject">Предмет</label>
        <div id="subjectStatus" class="status" style="display:none">
          <span class="spinner"></span><span>Поиск предметов…</span>
        </div>
        <select id="subject" disabled><option>Загрузка…</option></select>
      </div>

      <div>
        <label for="group">Группа</label>
        <div id="groupStatus" class="status" style="display:none">
          <span class="spinner"></span><span>Поиск групп…</span>
        </div>
        <select id="group" disabled><option>Сначала выберите предмет</option></select>
      </div>

      <button class="btn" id="showBtn" disabled><span>Показать учеников</span></button>
    </div>
  </section>

  <!-- Список учеников + нарушения -->
  <section class="card" id="workCard" style="display:none" aria-live="polite">
    <div class="row">
      <div id="studentsStatus" class="status" style="display:none">
        <span class="spinner"></span><span>Ищем учеников…</span>
      </div>

      <div class="students" id="students"></div>

      <div>
        <label>Тип нарушения (можно несколько)</label>
        <div class="checks">
          <label class="check"><input type="checkbox" name="vio" value="Плохое поведение">Плохое поведение</label>
          <label class="check"><input type="checkbox" name="vio" value="Плохие оценки">Плохие оценки</label>
          <label class="check"><input type="checkbox" name="vio" value="Опоздание">Опоздание</label>
        </div>
      </div>

      <div>
        <label for="comment">Комментарий</label>
        <textarea id="comment" placeholder="Кратко опишите суть нарушения…"></textarea>
      </div>

      <div class="row">
        <button class="btn" id="sendBtn"><span>Отправить в журнал</span></button>
        <p id="msg" class="muted"></p>
      </div>

      <div id="afterSend" style="display:none">
        <div class="chips" id="summary"></div>
        <div style="height:8px"></div>
        <button class="btn secondary" id="closeBtn">Закрыть</button>
      </div>
    </div>
  </section>
</div>

<div id="snack" class="snackbar" role="status" aria-live="polite">Сохранено</div>

<script>
  // ====== ВАЖНО: замените на ваш URL развернутого Apps Script ======
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxmFnd_P68cjOhUrsR6VWBOvQm2yjTQSKy7kcQD7_yYvr6G-aMVNinXGGgfcleqDL1H/exec";

  // JSONP helper (массивы склеиваем запятыми)
  function jsonp(url, params, onDone, onFail){
    const cb = "cb"+Math.random().toString(36).slice(2);
    const sp = new URLSearchParams({callback:cb});
    if(params) for(const [k,v] of Object.entries(params)) sp.set(k, Array.isArray(v)?v.join(','):v);
    const s=document.createElement('script');
    window[cb]=d=>{cleanup(); onDone&&onDone(d)};
    s.onerror=()=>{cleanup(); onFail&&onFail(new Error('JSONP load error'))};
    s.src=`${url}?${sp.toString()}`; document.body.appendChild(s);
    function cleanup(){ delete window[cb]; s.remove(); }
  }

  const $ = id=>document.getElementById(id);
  const teacherInp=$('teacher'), subjectSel=$('subject'), groupSel=$('group');
  const showBtn=$('showBtn'), workCard=$('workCard'), studentsList=$('students');
  const subjectStatus=$('subjectStatus'), groupStatus=$('groupStatus'), studentsStatus=$('studentsStatus');
  const sendBtn=$('sendBtn'), msgEl=$('msg'), snack=$('snack'), afterSend=$('afterSend'), summary=$('summary');

  // LocalStorage для преподавателя
  const LS_KEY_TEACHER = 'ejournal.teacher';
  function loadTeacher(){ const v = localStorage.getItem(LS_KEY_TEACHER); if (v) { teacherInp.value=v; $('teacherHint').textContent='(имя сохранено на этом устройстве)'; } }
  let _tSave; function debouncedSave(){ clearTimeout(_tSave); _tSave=setTimeout(()=>{ const v=teacherInp.value.trim(); if(v) localStorage.setItem(LS_KEY_TEACHER,v); }, 300); }

  function setLoading(el,on,text){ el.style.display=on?'flex':'none'; if(text) el.querySelector('span:last-child').textContent=text; }
  function setBtnLoading(btn,on,labelLoading){
    if(on){ btn.dataset.label=btn.textContent.trim(); btn.disabled=true; btn.innerHTML=`<span class="spinner"></span><span>${labelLoading}</span>`; }
    else { btn.disabled=false; btn.innerHTML=`<span>${btn.dataset.label||'Готово'}</span>`; delete btn.dataset.label; }
  }
  function updateShowBtnState(){ showBtn.disabled=!subjectSel.value||!groupSel.value; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function showSnack(t='Сохранено'){ snack.textContent=t; snack.classList.add('show'); setTimeout(()=>snack.classList.remove('show'),2000); }

  // Предметы
  function loadSubjects(){
    setLoading(subjectStatus,true,'Поиск предметов…'); subjectSel.disabled=true;
    jsonp(SCRIPT_URL,{action:'subjects'},(d)=>{
      subjectSel.innerHTML='<option value="">— выберите предмет —</option>';
      if(d&&d.ok) (d.data||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s;o.textContent=s; subjectSel.appendChild(o); });
      else subjectSel.innerHTML='<option value="">Ошибка загрузки</option>';
      subjectSel.disabled=false; setLoading(subjectStatus,false); updateShowBtnState();
    },()=>{ subjectSel.innerHTML='<option value="">Ошибка сети</option>'; subjectSel.disabled=false; setLoading(subjectStatus,false); });
  }

  // Группы при смене предмета
  subjectSel.addEventListener('change',()=>{
    workCard.style.display='none'; studentsList.innerHTML=''; afterSend.style.display='none'; msgEl.textContent='';
    const subject=subjectSel.value.trim();
    if(!subject){ groupSel.innerHTML='<option value="">Сначала выберите предмет</option>'; groupSel.disabled=true; updateShowBtnState(); return; }
    setLoading(groupStatus,true,'Поиск групп…'); groupSel.disabled=true;
    jsonp(SCRIPT_URL,{action:'groups',subject},(d)=>{
      groupSel.innerHTML=(d&&d.ok&&d.data.length)?'<option value="">— выберите группу —</option>':'<option value="">Группы не найдены</option>';
      if(d&&d.ok) (d.data||[]).forEach(g=>{ const o=document.createElement('option'); o.value=g;o.textContent=g; groupSel.appendChild(o); });
      groupSel.disabled=false; setLoading(groupStatus,false); updateShowBtnState();
    },()=>{ groupSel.innerHTML='<option value="">Ошибка сети</option>'; groupSel.disabled=false; setLoading(groupStatus,false); });
  });

  // Показать учеников
  showBtn.addEventListener('click',()=>{
    const subject=subjectSel.value.trim(), group=groupSel.value.trim(); if(!subject||!group) return;
    workCard.style.display='block'; studentsList.innerHTML=''; afterSend.style.display='none'; msgEl.textContent='';
    setBtnLoading(showBtn,true,'Ищем учеников…'); setLoading(studentsStatus,true,'Ищем учеников…');
    jsonp(SCRIPT_URL,{action:'students',subject,group},(d)=>{
      setBtnLoading(showBtn,false); setLoading(studentsStatus,false);
      if(!(d&&d.ok)){ studentsList.innerHTML='<div class="muted">Ошибка загрузки</div>'; return; }
      const arr=d.data||[]; if(!arr.length){ studentsList.innerHTML='<div class="muted">По выбранным параметрам «Активных» учеников не найдено.</div>'; return; }
      arr.forEach(st=>{
        const row=document.createElement('div'); row.className='student';
        const id='st_'+Math.random().toString(36).slice(2);
        row.innerHTML=`<label for="${id}">${escapeHtml(st)}</label>
          <input id="${id}" type="checkbox" value="${escapeHtml(st)}">`;
        studentsList.appendChild(row);
      });
    },()=>{ setBtnLoading(showBtn,false); setLoading(studentsStatus,false); studentsList.innerHTML='<div class="muted">Ошибка сети</div>'; });
  });

  // Отправка нарушений
  sendBtn.addEventListener('click',()=>{
    const teacher=teacherInp.value.trim(), subject=subjectSel.value.trim(), group=groupSel.value.trim();
    const students=Array.from(studentsList.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);
    const violations=Array.from(document.querySelectorAll('input[name="vio"]:checked')).map(cb=>cb.value);
    const comment=$('comment').value.trim();

    if(!teacher||!subject||!group){ msgEl.textContent='Заполните: преподаватель, предмет, группа'; return; }
    if(students.length===0){ msgEl.textContent='Выберите хотя бы одного ученика'; return; }
    if(violations.length===0){ msgEl.textContent='Отметьте хотя бы один тип нарушения'; return; }

    localStorage.setItem(LS_KEY_TEACHER, teacher);

    setBtnLoading(sendBtn,true,'Сохраняем…');
    jsonp(SCRIPT_URL,{
      action:'submitviolations',
      teacher, subject, group,
      students, violations,
      comment
    },(res)=>{
      setBtnLoading(sendBtn,false);
      if(res&&res.ok){
        showSnack('Сохранено');
        msgEl.textContent = `Создано записей: ${students.length}`;
        afterSend.style.display='block';
        summary.innerHTML='';
        const chips = [
          ['Преподаватель', teacher],
          ['Предмет', subject],
          ['Группа', group],
          ['Ученики', students.join(', ')],
          ['Нарушения', violations.join(', ')],
          ['Комментарий', comment || '—']
        ];
        chips.forEach(([k,v])=>{
          const c=document.createElement('div'); c.className='chip'; c.textContent=`${k}: ${v}`; summary.appendChild(c);
        });
        // очистим выбор
        studentsList.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
        document.querySelectorAll('input[name="vio"]').forEach(cb=>cb.checked=false);
        $('comment').value='';
      }else{
        msgEl.textContent=(res&&res.message)||'Ошибка при сохранении';
      }
    },(e)=>{ setBtnLoading(sendBtn,false); msgEl.textContent='Ошибка сети: '+e.message; });
  });

  $('closeBtn')?.addEventListener('click',()=>{ try{ window.open('','_self'); window.close(); }catch(e){ location.href='about:blank'; } });

  // init
  document.addEventListener('DOMContentLoaded', ()=>{
    loadTeacher();
    loadSubjects();
  });
  groupSel.addEventListener('change',updateShowBtnState);
  teacherInp.addEventListener('input', debouncedSave);
</script>
</body>
</html>
